<template>
  <div class="slds-p-around_medium">
    <!-- Status bar -->
    <div
      class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_info slds-m-bottom_small"
      role="status"
    >
      <span class="slds-assistive-text">info</span>
      <span class="slds-icon_container slds-m-right_x-small" title="info"
        >ℹ️</span
      >
      <h2>{statusText}</h2>
    </div>

    <!-- Spinner -->
    <template if:true={isBusy}>
      <lightning-spinner size="small" variant="brand"></lightning-spinner>
    </template>

    <!-- Top controls: Target Object • Project • Version -->
    <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_small">
      <div class="slds-size_1-of-1 slds-medium-size_1-of-3">
        <lightning-combobox
          name="targetObject"
          label="Target Object"
          value={selectedObjectApiName}
          options={objectOptions}
          placeholder="Select an object"
          onchange={handleObjectPick}
        >
        </lightning-combobox>
      </div>

      <div class="slds-size_1-of-1 slds-medium-size_1-of-3">
        <lightning-combobox
          name="project"
          label="Project"
          value={selectedProjectId}
          options={projectOptions}
          placeholder="Select a project"
          onchange={handleProjectPick}
        >
        </lightning-combobox>
      </div>

      <div class="slds-size_1-of-1 slds-medium-size_1-of-3">
        <lightning-input
          type="text"
          label="Version"
          value={selectedVersion}
          onchange={handleVersionChange}
        >
        </lightning-input>
      </div>
    </div>

    <!-- Mapping grid -->
    <template if:true={hasColumns}>
      <div class="slds-text-title_caps slds-m-bottom_x-small">
        Map CSV columns to {selectedObjectApiName}
      </div>

      <div class="table-wrap">
        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
          <thead>
            <tr>
              <th scope="col">CSV Column</th>
              <th scope="col">Target Field</th>
              <th scope="col" style="width: 110px">Lookup?</th>
              <th scope="col">Lookup Object</th>
              <th scope="col">Match Field</th>
            </tr>
          </thead>
          <tbody>
            <template for:each={rows} for:item="r">
              <tr key={r.key}>
                <td>{r.sourceColumn}</td>

                <td>
                  <lightning-combobox
                    data-key={r.key}
                    value={r.targetField}
                    options={fieldOptions}
                    placeholder="-- none --"
                    onchange={handleFieldPick}
                  >
                  </lightning-combobox>
                </td>

                <td class="slds-text-align_center">
                  <lightning-input
                    type="checkbox"
                    data-key={r.key}
                    checked={r.isLookup}
                    onchange={handleLookupToggle}
                  >
                  </lightning-input>
                </td>

                <td>
                  <lightning-combobox
                    data-key={r.key}
                    value={r.lookupObject}
                    options={objectOptions}
                    placeholder="Select object"
                    disabled={r.disabledLookup}
                    onchange={handleLookupObjectPick}
                  >
                  </lightning-combobox>
                </td>

                <td>
                  <lightning-combobox
                    data-key={r.key}
                    value={r.lookupMatchField}
                    options={r.lookupMatchFieldOptions}
                    placeholder="Field on lookup object"
                    disabled={r.disabledLookup}
                    onchange={handleLookupMatchFieldPick}
                  >
                  </lightning-combobox>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="slds-m-top_medium slds-align_absolute-center">
        <lightning-button
          variant="brand"
          label="Save mappings"
          onclick={handleSave}
          disabled={isSaveDisabled}
        >
        </lightning-button>

        <lightning-button
          class="slds-m-left_small"
          label="Load existing"
          onclick={handleLoadExisting}
          disabled={disableLoad}
        >
        </lightning-button>
      </div>
    </template>

    <template if:false={hasColumns}>
      <p class="slds-text-color_weak">
        Upload a CSV (or provide columns) to start mapping.
      </p>
    </template>
  </div>
</template>
